{"version":3,"names":["NDKEvent","deserialize","NDKKind","LRUCache","SQLite","matchFilter","migrations","NDKCacheAdapterSqlite","locking","ready","pendingCallbacks","constructor","dbName","maxProfiles","profileCache","maxSize","initialize","db","openDatabaseAsync","user_version","schemaVersion","getFirstSync","execAsync","Number","length","withTransactionAsync","i","up","e","console","error","Promise","all","map","f","onReady","callback","unshift","query","subscription","filter","filters","authors","events","getAllSync","join","foundEvents","kinds","setEvent","event","relay","filterTags","tags","tag","runAsync","id","created_at","pubkey","serialize","kind","url","EventDeletion","deleteEventIds","eventIds","fetchProfileSync","cached","get","result","profile","JSON","parse","entry","fetchedAt","catched_at","set","fetchProfile","saveProfile","existingProfile","now","Date","stringify","addUnpublishedEvent","relayUrls","relayStatus","forEach","runSync","onPublished","record","off","relays","successWrites","Object","values","v","unsuccessWrites","discardUnpublishedEvent","once","getUnpublishedEvents","call","_getUnpublishedEvents","resolve","reject","push","then","catch","getAllAsync","deserializedEvent","undefined","keys","lastTryAt","last_try_at","eventId","limit","sort","a","b","slice","foundEvent","relayUrl","ndkEvent","pool","getRelay","eventReceived"],"sourceRoot":"../../../src","sources":["cache-adapter/sqlite.ts"],"mappings":"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","ignoreList":[]}
